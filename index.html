<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Rounds Board Review</title>
    <!-- Mermaid for rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Markdown for chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Pan/Zoom for Map -->
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .video-container {
            flex: 1;
            background-color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-left: 1px solid #ddd;
            overflow: hidden;
            position: relative;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            z-index: 10;
        }

        .tab-button {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background-color: white;
        }

        .tab-content {
            display: none;
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            height: 100%;
            box-sizing: border-box;
        }

        .tab-content.active {
            display: block;
        }

        /* Quiz Styles */
        .question-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }

        .question-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .options {
            list-style-type: none;
            padding: 0;
        }

        .option {
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .option:hover {
            background-color: #f9f9f9;
            border-color: #bbb;
        }

        .option.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .option.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .rationale {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #17a2b8;
            font-size: 0.95rem;
            display: none;
        }

        .timestamp-link {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .timestamp-link:hover {
            text-decoration: underline;
        }

        /* Map Styles - Canvas Look */
        #map {
            padding: 0; /* Full width/height for canvas */
            background-color: #f8f9fa;
            background-image: radial-gradient(#cfcfcf 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            overflow: hidden; /* Pan/Zoom library handles scroll */
        }

        #mermaid-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #mermaid-container {
            width: 100%;
            height: 100%;
        }
        
        /* Hidden source blocks */
        .mermaid-source-block {
            display: none;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background-color: #f0f0f0;
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100%;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            max-width: 85%;
        }

        .chat-message.user {
            margin-left: auto;
            background-color: #e3f2fd;
            padding: 0.8rem 1rem;
            border-radius: 15px 15px 0 15px;
            color: #0d47a1;
        }

        .chat-message.bot {
            margin-right: auto;
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 0.8rem 1rem;
            border-radius: 15px 15px 15px 0;
            color: #333;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            padding-bottom: 10px;
        }

        #chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        #send-btn {
            padding: 0.8rem 1.5rem;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        #send-btn:hover {
            background-color: #1a252f;
        }

        #send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .typing-indicator {
            font-style: italic;
            color: #888;
            font-size: 0.9rem;
            margin-left: 1rem;
            display: none;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .video-container {
                flex: none;
                height: 40vh; 
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Grand Rounds: Great Mimickers</h1>
    </header>
    <div class="container">
        <div class="video-container">
            <div id="player"></div>
        </div>
        <div class="content-container">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('quiz')">Board Review Quiz</button>
                <button class="tab-button" onclick="switchTab('map')">Visual Differential Map</button>
                <button class="tab-button" onclick="switchTab('hotseat')">Hot Seat (Live)</button>
                <button class="tab-button" onclick="switchTab('chat')">Ask the Speaker</button>
            </div>
            
            <!-- QUIZ TAB -->
            <div id="quiz" class="tab-content active">
                <p>Loading quiz data...</p>
            </div>

            <!-- HOT SEAT TAB -->
            <div id="hotseat" class="tab-content">
                <div id="hotseat-status" style="padding: 40px 20px; text-align: center; color: #546e7a;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è</div>
                    <h3 style="margin: 0 0 10px 0; color: #37474f;">Clinical Simulation Active</h3>
                    <p style="font-size: 1.1rem; margin: 0;">Follow the case presentation. The simulation will pause at critical decision points for you to weigh in.</p>
                </div>
                <div id="hotseat-interaction" style="display:none;">
                    <!-- Dynamic Content injected here -->
                </div>
            </div>
            
            <!-- MAP TAB -->
            <div id="map" class="tab-content">
                <!-- Source for Visual Map -->
                <pre id="mermaid-source" class="mermaid-source-block">
graph TD
    classDef Phase1 fill:#e0f7fa,stroke:#00796b,stroke-width:2px;
    classDef Phase2 fill:#fff3e0,stroke:#f57c00,stroke-width:2px;
    classDef Phase3 fill:#e8f5e9,stroke:#388e3c,stroke-width:2px;

    subgraph Phase_1 [The Clinical Puzzle]
        Patient(&quot;46M with Hx of&lt;br&gt;Atrial Pseudoaneurysm Repair&quot;)
        Presentation(&quot;New Onset:&lt;br&gt;Chest Pain, Headache,&lt;br&gt;Word-Finding Difficulty&quot;)
        Imaging(&quot;Multi-System Lesions:&lt;br&gt;Lungs (Halo Sign), Brain,&lt;br&gt;Pericardium, Bone&quot;)
        Lab(&quot;Key Lab Finding:&lt;br&gt;Peripheral Eosinophilia&quot;)
        Dilemma(&quot;The Dilemma:&lt;br&gt;Widespread disease in a&lt;br&gt;previously healthy world traveler&quot;)
    end

    subgraph Phase_2 [The Differential Debate]
        CentralQuestion(&quot;Central Question:&lt;br&gt;Infection vs. Malignancy?&quot;)
        InfectiousDDx(&quot;Hypothesis: Atypical Infection&lt;br&gt;‚Ä¢ Mycobacterial (TB/NTM)&lt;br&gt;‚Ä¢ Endemic Fungi&lt;br&gt;‚Ä¢ Nocardia / Melioidosis&lt;br&gt;‚Ä¢ Brucellosis&quot;)
        MalignancyDDx(&quot;Hypothesis: Malignancy / Inflammatory&lt;br&gt;‚Ä¢ Lymphoma&lt;br&gt;‚Ä¢ Sarcoma&lt;br&gt;‚Ä¢ Histiocytosis&quot;)
        Workup(&quot;Extensive Infectious Workup:&lt;br&gt;BAL, CSF, Blood Cultures,&lt;br&gt;Serologies --&gt; All Negative&quot;)
        TurningPoint(&quot;The Turning Point:&lt;br&gt;Biopsy of Pericardial Lymph Node&quot;)
    end

    subgraph Phase_3 [Resolution &amp; Wisdom]
        Diagnosis(&quot;Final Diagnosis:&lt;br&gt;Cardiac Angiosarcoma&quot;)
        TeachingPoint1(&quot;Primary Teaching Point:&lt;br&gt;Angiosarcoma is a great mimicker&lt;br&gt;of infectious pericarditis &amp; sepsis&quot;)
        TeachingPoint2(&quot;Clinical Pearl:&lt;br&gt;Always consider malignancy when&lt;br&gt;an &#x27;infection&#x27; fails to respond&lt;br&gt;or has atypical features&quot;)
    end

    %% Flow
    Patient --&gt; Presentation --&gt; Imaging &amp; Lab
    Imaging --&gt; Dilemma
    Lab --&gt; Dilemma
    Dilemma --&gt; CentralQuestion
    CentralQuestion --&gt; InfectiousDDx
    CentralQuestion --&gt; MalignancyDDx
    InfectiousDDx --&gt; Workup
    MalignancyDDx --&gt; Workup
    Workup --&gt; TurningPoint
    TurningPoint --&gt; Diagnosis
    Diagnosis --&gt; TeachingPoint1
    TeachingPoint1 --&gt; TeachingPoint2

    %% Styling
    class Patient,Presentation,Imaging,Lab,Dilemma Phase1;
    class CentralQuestion,InfectiousDDx,MalignancyDDx,Workup,TurningPoint Phase2;
    class Diagnosis,TeachingPoint1,TeachingPoint2 Phase3;
</pre>
                
                <div id="mermaid-wrapper">
                    <div id="mermaid-container"></div>
                </div>

                <!-- Zoom Controls -->
                <div class="map-controls">
                    <button class="control-btn" onclick="zoomMap(1.2)" title="Zoom In">+</button>
                    <button class="control-btn" onclick="zoomMap(0.8)" title="Zoom Out">-</button>
                    <button class="control-btn" onclick="resetMap()" title="Reset View">‚Ü∫</button>
                </div>
            </div>

            <!-- CHAT TAB -->
            <div id="chat" class="tab-content">
                <div class="chat-container">
                    <div class="chat-history" id="chat-history">
                        <div class="chat-message bot">
                            Hello! I am the AI representation of the speaker. Ask me anything about the "Great Mimickers" presentation.
                        </div>
                    </div>
                    <div class="typing-indicator" id="typing-indicator">The speaker is thinking...</div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="e.g., What are the symptoms of Brucellosis?" onkeypress="handleEnter(event)">
                        <button id="send-btn" onclick="sendMessage()">Ask</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- YouTube API ---
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'mM3mutz432w',
                playerVars: { 'playsinline': 1 },
                events: { 'onReady': onPlayerReady }
            });
        }

        function onPlayerReady(event) { }

        function seekToTimestamp(seconds) {
            if (player && player.seekTo) {
                player.seekTo(seconds, true);
                player.playVideo();
            }
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);


        // --- UI Logic, Mermaid & PanZoom ---
        let mermaidInitialized = false;
        let panZoomInstance = null;

        async function initMermaid() {
            // If already initialized, do nothing
            if (mermaidInitialized) return;
            
            const sourceElement = document.getElementById('mermaid-source');
            if (!sourceElement) return;
            const source = sourceElement.textContent;
            
            const container = document.getElementById('mermaid-container');
            
            mermaid.initialize({ 
                startOnLoad: false, 
                securityLevel: 'loose',
                theme: 'default'
            });

            try {
                // Render graph
                const { svg } = await mermaid.render('graphDiv', source);
                container.innerHTML = svg;
                mermaidInitialized = true;

                // Initialize PanZoom after SVG is in DOM
                const svgElement = container.querySelector('svg');
                if (svgElement) {
                    // Set explicit width/height to 100% for container scaling
                    svgElement.setAttribute('width', '100%');
                    svgElement.setAttribute('height', '100%');
                    // Remove fixed inline styles that mermaid might add
                    svgElement.style.maxWidth = ''; 
                    
                    // Destroy previous instance if exists
                    if (panZoomInstance) {
                        panZoomInstance.destroy();
                    }

                    panZoomInstance = svgPanZoom(svgElement, {
                        zoomEnabled: true,
                        controlIconsEnabled: false, // We built custom ones
                        fit: true,
                        center: true,
                        minZoom: 0.1,
                        maxZoom: 10,
                        onUpdatedCTM: function() {
                            // Optional: could handle updates here
                        }
                    });

                    // Force a resize/fit after a short delay to ensure container layout is final
                    setTimeout(() => {
                        panZoomInstance.resize();
                        panZoomInstance.fit();
                        panZoomInstance.center();
                        // Zoom out slightly to provide margin
                        panZoomInstance.zoomBy(0.9); 
                    }, 100);
                }
            } catch (e) {
                container.innerHTML = 'Error rendering map: ' + e.message;
                console.error(e);
            }
        }

        // Handle Window Resize
        window.addEventListener('resize', () => {
            if (panZoomInstance) {
                panZoomInstance.resize();
                panZoomInstance.fit();
                panZoomInstance.center();
            }
        });

        function zoomMap(scale) {
            if (panZoomInstance) {
                panZoomInstance.zoomBy(scale);
            }
        }

        function resetMap() {
            if (panZoomInstance) {
                panZoomInstance.reset();
                panZoomInstance.fit();
                panZoomInstance.center();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.innerText.toLowerCase();
                
                // Mapping tabs to buttons
                if (tabName === 'map' && btnText.includes('visual')) btn.classList.add('active');
                else if (tabName === 'quiz' && btnText.includes('quiz')) btn.classList.add('active');
                else if (tabName === 'hotseat' && btnText.includes('hot')) btn.classList.add('active');
                else if (tabName === 'chat' && btnText.includes('ask')) btn.classList.add('active');
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Map tab logic
            if (tabName === 'map') {
                document.getElementById('map').classList.add('active');
                setTimeout(initMermaid, 50);
            } else {
                document.getElementById(tabName).classList.add('active');
            }
        }

        // --- Data Loading ---
        let hotSeatStops = [];
        let hotSeatActive = false; // Prevent multiple triggers for same stop

        async function loadData() {
            try {
                const qResp = await fetch('quiz_data.json');
                const qData = await qResp.json();
                renderQuiz(qData.questions);
            } catch (e) {
                document.getElementById('quiz').innerHTML = '<p>Error loading quiz. Make sure server.py is running.</p>';
            }

            try {
                const hsResp = await fetch('simulation_data.json');
                const hsData = await hsResp.json();
                
                // Handle both array format (new) and object format (old)
                let rawStops = [];
                if (Array.isArray(hsData)) {
                    rawStops = hsData;
                } else if (hsData.stops) {
                    rawStops = hsData.stops;
                }
                
                // Map new schema to internal structure if needed, or just use new fields
                hotSeatStops = rawStops.map(stop => ({
                    ...stop,
                    // Compatibility mapping
                    timestamp_seconds: stop.stop_timestamp_seconds || stop.timestamp_seconds,
                    answer_timestamp_seconds: stop.resume_timestamp_seconds || stop.answer_timestamp_seconds,
                    question: stop.question_for_trainee || stop.question_for_learner || stop.prompt || stop.question,
                    phase_name: stop.title || stop.decision_point_name || stop.stop_title || stop.phase_name
                })).sort((a, b) => a.timestamp_seconds - b.timestamp_seconds);
                
                // Ensure sequence_id exists
                hotSeatStops.forEach((stop, index) => {
                    if (!stop.sequence_id && !stop.id) stop.sequence_id = index + 1;
                });

                console.log("Hot Seat stops loaded:", hotSeatStops);
                startHotSeatMonitor();
            } catch (e) {
                console.log("Hot Seat data not found or error loading:", e);
            }
        }

        function startHotSeatMonitor() {
            setInterval(() => {
                if (!player || typeof player.getCurrentTime !== 'function') return;
                
                const currentTime = player.getCurrentTime();
                // Check if we are near a stop (within 2 seconds) and haven't triggered it yet
                const nextStop = hotSeatStops.find(s => Math.abs(s.timestamp_seconds - currentTime) < 1.5);
                
                if (nextStop && !hotSeatActive) {
                    triggerHotSeat(nextStop);
                }
            }, 1000);
        }

        function triggerHotSeat(stopData) {
            hotSeatActive = true;
            player.pauseVideo();
            switchTab('hotseat');
            
            const container = document.getElementById('hotseat-interaction');
            const status = document.getElementById('hotseat-status');
            
            status.style.display = 'none';
            container.style.display = 'block';
            
            // Handle nested feedback object or flat fields (compatibility)
            const feedback = stopData.feedback || stopData;
            const question = stopData.question_for_learner || stopData.clinical_question || stopData.prompt || stopData.question;
            const title = stopData.decision_point_name || stopData.stop_title || stopData.phase_name;

            // Append new interaction to history instead of overwriting
            const interactionDiv = document.createElement('div');
            interactionDiv.className = 'hotseat-history-item';
            interactionDiv.style.marginBottom = '40px';
            
            // PROFESSIONAL DESIGN
            interactionDiv.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e0e0e0; margin-bottom: 24px;">
                    <div style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #7f8c8d; letter-spacing: 1px; margin-bottom: 12px;">
                        Clinical Decision Node
                    </div>
                    <h3 style="margin: 0 0 16px 0; color: #2c3e50; font-size: 1.3rem; font-weight: 600;">${title}</h3>
                    <p style="font-size: 1.05rem; line-height: 1.7; color: #34495e; margin-bottom: 24px;">${question}</p>
                    
                    <div>
                        <textarea id="user-rationale-${stopData.sequence_id || stopData.id}" rows="3" 
                            style="width:100%; padding:14px; border:1px solid #dcdcdc; border-radius:6px; font-family: 'Segoe UI', sans-serif; font-size: 1rem; line-height: 1.5; resize: vertical; transition: border-color 0.2s;" 
                            placeholder="Share your reasoning..."></textarea>
                        <button onclick="commitAnswer(${stopData.sequence_id || stopData.id})" 
                            style="background-color: #3498db; color: white; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 12px; font-size: 0.95rem; transition: background 0.2s;">
                            Submit & Compare
                        </button>
                    </div>
                </div>

                <div id="expert-feedback-${stopData.sequence_id || stopData.id}" style="display:none;">
                    
                    <!-- AI Feedback Section -->
                    <div class="ai-feedback-slot"></div>

                    <div style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; overflow: hidden; margin-top: 24px;">
                        <div style="background: #e9ecef; padding: 12px 20px; font-size: 0.85rem; font-weight: 700; color: #495057; text-transform: uppercase; letter-spacing: 0.5px;">
                            The Expert's Perspective
                        </div>
                        <div style="padding: 24px;">
                            <p style="margin: 0 0 20px 0; line-height: 1.7; color: #2c3e50; font-size: 1rem;">${feedback.expert_insight || feedback.expert_thinking}</p>
                            
                            ${feedback.expert_quote_verbatim ? 
                                `<div style="position: relative; padding-left: 20px; border-left: 4px solid #bdc3c7; margin-bottom: 20px;">
                                    <div style="font-family: Georgia, serif; font-size: 1.1rem; font-style: italic; color: #555; line-height: 1.6;">
                                        ‚Äú${feedback.expert_quote_verbatim}‚Äù
                                    </div>
                                    <div style="font-size: 0.8rem; color: #95a5a6; margin-top: 6px;">‚Äî Verbatim Transcript</div>
                                </div>` : ''}

                            ${feedback.novice_trap ? 
                                `<div style="background: #fff3cd; padding: 16px; border-radius: 6px; border: 1px solid #ffeeba; color: #856404; font-size: 0.95rem; line-height: 1.6;">
                                    <strong>‚ö†Ô∏è Common Pitfall:</strong> ${feedback.novice_trap}
                                </div>` : ''}
                        </div>
                        <div style="background: #f1f3f5; padding: 16px 24px; border-top: 1px solid #e9ecef; display: flex; gap: 12px;">
                            ${stopData.answer_timestamp_seconds ? 
                                `<button onclick="jumpToExpert(${stopData.answer_timestamp_seconds})" style="background-color: #2c3e50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚ñ∂ Watch Explanation</button>` 
                                : ''}
                            <button onclick="resumeVideo()" style="background-color: white; color: #495057; border: 1px solid #ced4da; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">Continue Case</button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(interactionDiv);
        }

        function jumpToExpert(seconds) {
            hotSeatActive = false;
            
            // Log the action in the history stream instead of hiding everything
            const container = document.getElementById('hotseat-interaction');
            const logDiv = document.createElement('div');
            logDiv.style.textAlign = 'center';
            logDiv.style.margin = '20px 0';
            logDiv.style.color = '#666';
            logDiv.style.fontSize = '0.9em';
            logDiv.innerHTML = `<em>--- Jumping to Expert Explanation (${formatTime(seconds)}) ---</em>`;
            container.appendChild(logDiv);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;

            player.seekTo(seconds, true);
            player.playVideo();
        }

        async function commitAnswer(stopId) {
            const textArea = document.getElementById(`user-rationale-${stopId}`);
            const userAnswer = textArea.value.trim();
            // Find the button relative to the textarea (next sibling)
            const btn = textArea.nextElementSibling;
            
            if (!userAnswer) {
                alert("Please enter your reasoning before committing.");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Grading...";

            // Find current stop data (handle both ID formats)
            const stopData = hotSeatStops.find(s => (s.sequence_id || s.id) === stopId);
            const feedback = stopData.feedback || stopData;

            try {
                // Send to server for grading
                const response = await fetch('/grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_answer: userAnswer,
                        expert_context: feedback.expert_insight || feedback.expert_thinking,
                        novice_trap: feedback.novice_trap,
                        phase_name: stopData.decision_point_name || stopData.stop_title || stopData.phase_name
                    })
                });

                const result = await response.json();

                // Show feedback container
                const feedbackDiv = document.getElementById(`expert-feedback-${stopId}`);
                feedbackDiv.style.display = 'block';
                
                // Find the dedicated slot for AI feedback
                const aiSlot = feedbackDiv.querySelector('.ai-feedback-slot');
                
                // Inject AI Feedback (Professional Style)
                aiSlot.innerHTML = `
                    <div style="background: #e8f4fd; border: 1px solid #bbdefb; border-radius: 8px; overflow: hidden; margin-top: 24px;">
                        <div style="background: #bbdefb; padding: 12px 20px; font-size: 0.85rem; font-weight: 700; color: #0d47a1; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center;">
                            <span style="margin-right: 8px; font-size: 1.1rem;">ü§ñ</span> Personalized Feedback
                        </div>
                        <div style="padding: 24px; color: #1565c0; line-height: 1.7; font-size: 1rem;">
                            ${result.feedback}
                        </div>
                    </div>
                `;

            } catch (e) {
                alert("Error grading: " + e);
            } finally {
                btn.textContent = "Graded";
            }
        }

        function resumeVideo() {
            hotSeatActive = false; 
            
            const container = document.getElementById('hotseat-interaction');
            const logDiv = document.createElement('div');
            logDiv.style.textAlign = 'center';
            logDiv.style.margin = '20px 0';
            logDiv.style.color = '#666';
            logDiv.style.fontSize = '0.9em';
            logDiv.innerHTML = `<em>--- Video Resumed ---</em>`;
            container.appendChild(logDiv);

            container.scrollTop = container.scrollHeight;

            // Advance slightly so we don't re-trigger immediately
            player.seekTo(player.getCurrentTime() + 3, true);
            player.playVideo();
        }

        // --- Quiz Rendering ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function renderQuiz(questions) {
            const container = document.getElementById('quiz');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';

                const questionText = document.createElement('div');
                questionText.className = 'question-text';
                // Updated to match new JSON structure (question_text)
                questionText.textContent = `${index + 1}. ${q.question_text || q.question}`; 
                card.appendChild(questionText);

                const optionsList = document.createElement('ul');
                optionsList.className = 'options';

                // Determine correct answer string (handle index or direct string)
                let correctOptionStr = q.correctAnswer;
                if (q.correct_option_index !== undefined && q.options) {
                    correctOptionStr = q.options[q.correct_option_index];
                }

                q.options.forEach(opt => {
                    const li = document.createElement('li');
                    li.className = 'option';
                    li.textContent = opt;
                    li.onclick = () => checkAnswer(li, opt, correctOptionStr, rationaleDiv);
                    optionsList.appendChild(li);
                });
                card.appendChild(optionsList);

                const rationaleDiv = document.createElement('div');
                rationaleDiv.className = 'rationale';
                
                // Updated to match new JSON structure (explanation)
                const explanationText = q.explanation || q.rationale || "No explanation provided.";
                let rationaleHTML = `<p><strong>Rationale:</strong> ${explanationText}</p>`;
                
                // Handle timestamp reference (string range or number)
                let timestampVal = null;
                const tsRef = q.timestamp_reference || q.timestamp;
                
                if (tsRef) {
                    if (typeof tsRef === 'string') {
                        const match = tsRef.match(/(\d+)/);
                        if (match) timestampVal = parseInt(match[1], 10);
                    } else if (typeof tsRef === 'number') {
                        timestampVal = tsRef;
                    }
                }

                if (timestampVal !== null) {
                    rationaleHTML += `<p><a class="timestamp-link" onclick="seekToTimestamp(${timestampVal})">‚ñ∂ Jump to explanation at ${formatTime(timestampVal)}</a></p>`;
                }
                rationaleDiv.innerHTML = rationaleHTML;
                
                card.appendChild(rationaleDiv);
                container.appendChild(card);
            });
        }

        function checkAnswer(selectedLi, selectedOption, correctAnswer, rationaleDiv) {
            const parentUl = selectedLi.parentElement;
            if (parentUl.querySelector('.correct') || parentUl.querySelector('.incorrect')) return; 

            if (selectedOption === correctAnswer) {
                selectedLi.classList.add('correct');
            } else {
                selectedLi.classList.add('incorrect');
                Array.from(parentUl.children).forEach(li => {
                    if (li.textContent === correctAnswer) li.classList.add('correct');
                });
            }
            rationaleDiv.style.display = 'block';
        }

        // --- Chat Logic ---
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            document.getElementById('send-btn').disabled = true;
            document.getElementById('typing-indicator').style.display = 'block';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                if (data.reply) {
                    addMessageToChat('bot', data.reply);
                } else if (data.error) {
                    addMessageToChat('bot', "Error: " + data.error);
                }
            } catch (e) {
                addMessageToChat('bot', "Connection error. Is server.py running?");
            } finally {
                document.getElementById('send-btn').disabled = false;
                document.getElementById('typing-indicator').style.display = 'none';
            }
        }

        function addMessageToChat(role, text) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-message ${role}`;
            
            let formattedHtml = marked.parse(text);
            // Handle ranges: [T=123, T=456]
            formattedHtml = formattedHtml.replace(
                /\[T=(\d+),\s*T=(\d+)\]/g, 
                (match, start, end) => {
                    return `<a class="timestamp-link" onclick="seekToTimestamp(${start})">‚ñ∂ ${formatTime(start)} - ${formatTime(end)}</a>`;
                }
            );

            // Handle single timestamps: [T=123]
            formattedHtml = formattedHtml.replace(
                /\[T=(\d+)\]/g, 
                (match, seconds) => {
                    return `<a class="timestamp-link" onclick="seekToTimestamp(${seconds})">‚ñ∂ ${formatTime(seconds)}</a>`;
                }
            );

            div.innerHTML = formattedHtml;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>